# app端与服务端交互构思

1. 用户登陆

   1. 用户注册，向数据库中保存注册信息（涉及到密码的加密）

      1. 注册过程中通过短信验证码对手机号码进行验证，但还是需要保存一个密码

   2. 用户登陆：

      1. 账号密码登陆：
         * 输入账号密码，发送登陆请求，服务端拿到账号密码与数据库中的账号密码做校验，匹配，则生成Token返回给app端，app端进行保存，（服务端把token作为key，用户信息作为value存入session中）每次请求在请求头中带上token。app端请求过来先经过拦截器，在拦截流程中对token进行校验（校验过程是，查找session中是否有匹配的token键，如果有拦截器放行，如果没有重定向到登陆页面）

      2. 短信登陆

         1. 输入手机号，获取验证码，服务端拿到手机号和验证码之后，使用手机号在数据库中查找用户，

         * 使用手机号从数据库中查找到用户，校验验证码，成功后取出数据库中的用户数据用于保存为token的value，返回token给app端，之后的流程和账号密码登陆类似
         * 使用手机号从数据库中未查找到用户信息，返回错误提示（用户未注册之类的），然后重新走注册流程

   3. token的生成和刷新方案

      1. 如果用户有更改密码的操作，在更改密码成功后需要清除相应的token 
      2. 出于安全考虑，token在每次登录时重新生成，并可以设置有效期，每次有效操作后更新token的时间戳，保证token有效期往后延续。 
         1. 每次有效操作后，利用新的时间戳生成新的token从返回值中带给app端，同时删除原来的那个session。app端也同时更新token（如果会比较耗费资源的话就不刷新token了）
      3. 为了避免token被截获，伪造非法请求，在每次请求时，可以用  token+时间戳+密钥+请求参数，进行签名，服务端验证token，同时验证签名，以保证请求的安全性。（验证token是保证登陆的合法性，验证签名保证数据的合法性）

   4. 关于加密

      1. 参与加密的元素：
         1. appKey  与密钥appSecret是对应关系，是一个用于加密的参数
         2. 业务数据
         3. 时间戳
         4. appSecret   
      2. 加密方式   1+2+3+4 使用加密算法生成密文sc，app端发送请求时的参数为 1+2+3+sc
      3. 服务端校验方式   服务端使用1和4的对应关系获取到4，然后用同样的加密算法加密1+2+3+4生成密文ss，然后校验ss是否等于sc，等于则说明数据安全。

      4. 这种加密方式的安全性取决于1和4对应关系保存的安全性。
