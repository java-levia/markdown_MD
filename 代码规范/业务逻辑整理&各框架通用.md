# 业务逻辑整理&各框架通用

1. 关于订单流程
   1. 订单的取消
      * 订单的定时取消可以开启独立的线程进行执行（效率更高）（Q：这个线程在什么时候调用）
        * 取消订单过程中，第一步首先释放库存，库存的处理在支付业务逻辑类中有定义一个处理类。库存定义了五种修改类型
          1. 增加占用库存，减少原始库存（用户下单但未付款，订单商品被划入占用）
          2. 减少占用库存，增加销售库存（用户付款，订单商品由占用更改为销售）
          3. 减少原始库存，增加销售库存（用户付款，订单商品直接由原始改为销售）
          4. 减少占用库存，增加原始库存（用户取消订单或者超时取消订单释放库存操作）

2. 关于金额或积分的相关操作
	1. 金额或积分的增减操作
		1. 在操作积分/金额（point）之前先保存一个元数据originPoint（用于保存到BMoneyDetails中存储为操作前金额）
		2. 判断是否为进账类型，是则执行添加金额增加方法（FunctionUtils中封装了BigDecimal的add和sub方法），否则执行sub方法
		3. 对进行过add/sub的金额point进行判断，如果point<0，返回一条错误信息，上级方法会对返回信息进行判断，如果返回信息不为空会当做运行时异常处理。如果point>0程序继续向下执行
		4. 修改账户余额（根据版本号乐观锁），对修改操作的返回值进行判断，如果返回值小于1说明修改操作失败，此时返回一条错误信息，上级方法会对返回信息进行判断，如果返回信息不为空会当做运行时异常处理。
		5. 创建一个BMoneyDetails对象设置相关属性并插入到数据库
		6. 对整个过程try...catch...，如果出现异常，catch中抛出一个自定义的ServiceException（运行时异常的子类）

	2. 金额的冻结/解冻操作